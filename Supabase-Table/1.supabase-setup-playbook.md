
# OpenHR Supabase Setup Playbook

This document details the configuration and operational steps required to use Supabase as your backend.

## Phase 1: Database Initialization
Run the following SQL in your **Supabase SQL Editor** (found in the left sidebar of your Supabase dashboard). This creates the necessary tables and mappings.

```sql
-- 1. Create Employees Table (Profiles linked to Auth)
CREATE TABLE employees (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    role TEXT DEFAULT 'EMPLOYEE',
    department TEXT DEFAULT 'Unassigned',
    designation TEXT DEFAULT 'Staff',
    joining_date DATE DEFAULT CURRENT_DATE,
    mobile TEXT,
    emergency_contact TEXT,
    salary NUMERIC DEFAULT 0,
    status TEXT DEFAULT 'ACTIVE',
    avatar TEXT,
    employment_type TEXT DEFAULT 'PERMANENT',
    work_type TEXT DEFAULT 'OFFICE'
);

-- 2. Create Attendance Table
CREATE TABLE attendance (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    employee_id UUID REFERENCES employees(id) ON DELETE CASCADE,
    employee_name TEXT,
    date DATE NOT NULL DEFAULT CURRENT_DATE,
    check_in TEXT,
    check_out TEXT,
    status TEXT,
    location JSONB,
    selfie TEXT,
    remarks TEXT
);

-- 3. Create Leaves Table
CREATE TABLE leaves (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    employee_id UUID REFERENCES employees(id) ON DELETE CASCADE,
    employee_name TEXT,
    type TEXT,
    startDate DATE,
    endDate DATE,
    total_days INT,
    reason TEXT,
    status TEXT DEFAULT 'PENDING_MANAGER',
    applied_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    managerremarks TEXT,
    approverremarks TEXT
);

-- 4. Create Settings Table
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value JSONB
);
```

## Phase 2: Security (RLS Policies)
Row Level Security (RLS) ensures users can only see their own data while Admins see everything. Run this SQL:

```sql
-- Enable RLS on all tables
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance ENABLE ROW LEVEL SECURITY;
ALTER TABLE leaves ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;

-- EMPLOYEES POLICIES
CREATE POLICY "Employees are viewable by everyone." ON employees FOR SELECT USING (true);
CREATE POLICY "Users can update own profile." ON employees FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Admins have full access." ON employees FOR ALL USING (
  (SELECT role FROM employees WHERE id = auth.uid()) = 'ADMIN'
);

-- ATTENDANCE POLICIES
CREATE POLICY "Users can view own attendance." ON attendance FOR SELECT USING (auth.uid() = employee_id OR (SELECT role FROM employees WHERE id = auth.uid()) = 'ADMIN');
CREATE POLICY "Users can insert own attendance." ON attendance FOR INSERT WITH CHECK (auth.uid() = employee_id);

-- SETTINGS POLICIES
CREATE POLICY "Settings are viewable by authenticated users." ON settings FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Only admins can modify settings." ON settings FOR ALL USING ((SELECT role FROM employees WHERE id = auth.uid()) = 'ADMIN');
```

## Phase 3: Connecting the Frontend
1.  **Get Credentials**: In Supabase Dashboard, go to **Project Settings > API**.
2.  **URL**: Copy the `Project URL`.
3.  **Key**: Copy the `anon` `public` API Key.
4.  **OpenHR Settings**:
    *   Open the OpenHR app.
    *   On the Login screen, click **Enter Setup** or go to **Settings > Infrastructure**.
    *   Select the **Supabase** tab.
    *   Paste your **URL** and **Key**.
    *   Click **Save Config**.
    *   Click **Switch to Supabase**. The app will reload.

## Phase 4: Logging In & Granting Admin Access
1.  **First Login**: 
    *   Use an email/password you already created in **Supabase Auth > Users**.
    *   Upon first login, OpenHR will automatically create a matching record in the `employees` table with the `role` set to `EMPLOYEE`.
2.  **Elevating to Admin**:
    *   **Method A (Manual - Recommended)**: 
        1.  Go to your Supabase Dashboard.
        2.  Click **Table Editor** > **employees** table.
        3.  Find your user and double-click the `role` cell.
        4.  Change `EMPLOYEE` to `ADMIN` (must be all caps).
        5.  Refresh the OpenHR app. You now have full access.
    *   **Method B (Initial Bootstrap)**:
        1.  If no user in the `employees` table has the `ADMIN` role, a blue banner will appear at the top of the OpenHR dashboard.
        2.  Click **Claim Admin Role**. The app will update your database record automatically.

## Phase 5: Troubleshooting (401 Errors)
If you see a `401 Unauthorized` error in the console or a "Invalid Credentials" message:

1.  **Confirm User Account**: In the Supabase Dashboard > **Authentication > Users**, check the user's status. If it says "Waiting for Verification," you must manually confirm them by clicking the user and selecting **"Confirm User"** (or disable "Email Confirmation" in **Authentication > Settings**).
2.  **Verify Anon Key**: Ensure the `anon` key you pasted into the OpenHR settings is the **Public** key and not a service role key.
3.  **Self-Hosted Protocol**: If using an IP (like your screenshot), ensure your URL starts with `http://` or `https://`. Our latest update handles this, but double-check your settings.
4.  **CORS**: If using a self-hosted instance, ensure your browser domain (e.g., localhost) is added to the "Allowed Redirect URLs" or CORS whitelist in Supabase.
