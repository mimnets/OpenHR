
# OpenHR Supabase Setup Playbook

This document details the configuration and operational steps required to use Supabase as your backend.

## Phase 1: Database Initialization
Run the following SQL in your **Supabase SQL Editor** to create the required tables. Ensure the column names use **snake_case** as defined below.

```sql
-- 1. EMPLOYEES TABLE
CREATE TABLE IF NOT EXISTS public.employees (
  id uuid PRIMARY KEY DEFAULT auth.uid(),
  name text NOT NULL,
  email text NOT NULL,
  role text DEFAULT 'EMPLOYEE',
  department text DEFAULT 'Unassigned',
  designation text DEFAULT 'New Staff',
  avatar text,
  joining_date date DEFAULT CURRENT_DATE,
  mobile text,
  emergency_contact text,
  salary numeric DEFAULT 0,
  status text DEFAULT 'ACTIVE',
  employment_type text DEFAULT 'PERMANENT',
  location text DEFAULT 'HQ',
  nid text,
  line_manager_id uuid REFERENCES public.employees(id),
  work_type text DEFAULT 'OFFICE',
  created_at timestamp with time zone DEFAULT now()
);

-- 2. ATTENDANCE TABLE
CREATE TABLE IF NOT EXISTS public.attendance (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_id uuid REFERENCES public.employees(id) ON DELETE CASCADE,
  employee_name text,
  date date NOT NULL DEFAULT CURRENT_DATE,
  check_in text,
  check_out text,
  status text,
  location jsonb,
  remarks text,
  selfie text,
  created_at timestamp with time zone DEFAULT now()
);

-- 3. LEAVES TABLE
CREATE TABLE IF NOT EXISTS public.leaves (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_id uuid REFERENCES public.employees(id) ON DELETE CASCADE,
  employee_name text,
  type text NOT NULL,
  startDate date NOT NULL,
  endDate date NOT NULL,
  total_days integer,
  reason text,
  status text DEFAULT 'PENDING_MANAGER',
  applied_date timestamp with time zone DEFAULT now(),
  managerremarks text,
  approverremarks text
);

-- 4. SETTINGS TABLE
CREATE TABLE IF NOT EXISTS public.settings (
  key text PRIMARY KEY,
  value jsonb NOT NULL,
  updated_at timestamp with time zone DEFAULT now()
);
```

## Phase 2: Row Level Security (RLS) - FIX RECURSION
The error **"infinite recursion detected"** happens when a policy queries the same table it's protecting. Run these commands to fix it:

```sql
-- 1. Create a helper function to bypass RLS recursion
CREATE OR REPLACE FUNCTION public.get_my_role()
RETURNS text
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT role FROM public.employees WHERE id = auth.uid();
$$;

-- 2. Enable RLS on all tables
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance ENABLE ROW LEVEL SECURITY;
ALTER TABLE leaves ENABLE ROW LEVEL SECURITY;

-- 3. DROP OLD POLICIES
DROP POLICY IF EXISTS "Public profiles are viewable by everyone." ON employees;
DROP POLICY IF EXISTS "Users can insert own profile." ON employees;
DROP POLICY IF EXISTS "Users can update own profile." ON employees;
DROP POLICY IF EXISTS "Admins can do everything on employees." ON employees;

-- 4. EMPLOYEE TABLE POLICIES
CREATE POLICY "Public profiles are viewable by everyone." ON employees FOR SELECT USING (true);
CREATE POLICY "Users can insert own profile." ON employees FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update own profile." ON employees FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Admins can do everything on employees." ON employees FOR ALL TO authenticated USING (
  get_my_role() = 'ADMIN'
);

-- ... Repeat for other tables as defined in the previous section ...
```

## Phase 3: Enabling Realtime
1. Go to **Database** > **Replication** in the Supabase Sidebar.
2. Click on **'supabase_realtime'** publication.
3. Toggle the switch for `attendance`, `leaves`, and `employees`.
