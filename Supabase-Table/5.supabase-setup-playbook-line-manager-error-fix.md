
# OpenHR Supabase Setup Playbook

This document details the configuration and operational steps required to use Supabase as your backend.

## Phase 1: Database Initialization
Run the following SQL in your **Supabase SQL Editor** to create the required tables. Ensure the column names use **snake_case** as defined below.

```sql
-- 1. EMPLOYEES TABLE
CREATE TABLE IF NOT EXISTS public.employees (
  id uuid PRIMARY KEY DEFAULT auth.uid(),
  name text NOT NULL,
  email text NOT NULL,
  role text DEFAULT 'EMPLOYEE',
  department text DEFAULT 'Unassigned',
  designation text DEFAULT 'New Staff',
  avatar text,
  joining_date date DEFAULT CURRENT_DATE,
  mobile text,
  emergency_contact text,
  salary numeric DEFAULT 0,
  status text DEFAULT 'ACTIVE',
  employment_type text DEFAULT 'PERMANENT',
  location text DEFAULT 'HQ',
  nid text,
  line_manager_id uuid REFERENCES public.employees(id),
  work_type text DEFAULT 'OFFICE',
  created_at timestamp with time zone DEFAULT now()
);

-- 2. ATTENDANCE TABLE
CREATE TABLE IF NOT EXISTS public.attendance (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_id uuid REFERENCES public.employees(id) ON DELETE CASCADE,
  employee_name text,
  date date NOT NULL DEFAULT CURRENT_DATE,
  check_in text,
  check_out text,
  status text,
  location jsonb,
  remarks text,
  selfie text,
  created_at timestamp with time zone DEFAULT now()
);

-- 3. LEAVES TABLE
CREATE TABLE IF NOT EXISTS public.leaves (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_id uuid REFERENCES public.employees(id) ON DELETE CASCADE,
  employee_name text,
  type text NOT NULL,
  startDate date NOT NULL,
  endDate date NOT NULL,
  total_days integer,
  reason text,
  status text DEFAULT 'PENDING_MANAGER',
  applied_date timestamp with time zone DEFAULT now(),
  managerremarks text,
  approverremarks text
);

-- 4. SETTINGS TABLE
CREATE TABLE IF NOT EXISTS public.settings (
  key text PRIMARY KEY,
  value jsonb NOT NULL,
  updated_at timestamp with time zone DEFAULT now()
);
```

## Phase 2: Schema Repair (Fixing "Column Not Found")
If you are getting the error **"Could not find the 'line_manager_id' column"**, run this script in your Supabase SQL Editor:

```sql
-- 1. Add missing management column
ALTER TABLE public.employees ADD COLUMN IF NOT EXISTS line_manager_id uuid REFERENCES public.employees(id);

-- 2. Add other potential missing columns
ALTER TABLE public.employees ADD COLUMN IF NOT EXISTS location text DEFAULT 'HQ';
ALTER TABLE public.employees ADD COLUMN IF NOT EXISTS nid text;
ALTER TABLE public.employees ADD COLUMN IF NOT EXISTS salary numeric DEFAULT 0;
ALTER TABLE public.employees ADD COLUMN IF NOT EXISTS emergency_contact text;
ALTER TABLE public.employees ADD COLUMN IF NOT EXISTS work_type text DEFAULT 'OFFICE';

-- 3. CRITICAL: Refresh the schema cache
-- If the error persists after adding columns, run this or restart your project
NOTIFY pgrst, 'reload schema';
```

## Phase 3: Row Level Security (RLS) - FIX RECURSION
To prevent **"infinite recursion"** in policies, use this specialized helper function:

```sql
-- 1. Create a helper function to bypass RLS recursion
CREATE OR REPLACE FUNCTION public.get_my_role()
RETURNS text
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT role FROM public.employees WHERE id = auth.uid();
$$;

-- 2. Enable RLS
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance ENABLE ROW LEVEL SECURITY;
ALTER TABLE leaves ENABLE ROW LEVEL SECURITY;

-- 3. DROP OLD POLICIES
DROP POLICY IF EXISTS "Public profiles are viewable by everyone." ON employees;
DROP POLICY IF EXISTS "Users can insert own profile." ON employees;
DROP POLICY IF EXISTS "Users can update own profile." ON employees;
DROP POLICY IF EXISTS "Admins can do everything on employees." ON employees;

-- 4. EMPLOYEE TABLE POLICIES
CREATE POLICY "Public profiles are viewable by everyone." ON employees FOR SELECT USING (true);
CREATE POLICY "Users can insert own profile." ON employees FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update own profile." ON employees FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Admins can do everything on employees." ON employees FOR ALL TO authenticated USING (
  get_my_role() = 'ADMIN'
);
```
