
# OpenHR Supabase Setup Playbook

This document details the configuration and operational steps required to use Supabase as your backend.

## Phase 1: Database Initialization
Run the SQL in your **Supabase SQL Editor** to create the tables.

## Phase 2: Row Level Security (RLS) - FIX RECURSION
The error **"infinite recursion detected"** happens when a policy queries the same table it's protecting. Run these commands to fix it:

```sql
-- 1. Create a helper function to bypass RLS recursion
-- This function runs as the owner (SECURITY DEFINER)
CREATE OR REPLACE FUNCTION public.get_my_role()
RETURNS text
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT role FROM public.employees WHERE id = auth.uid();
$$;

-- 2. Enable RLS on all tables
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance ENABLE ROW LEVEL SECURITY;
ALTER TABLE leaves ENABLE ROW LEVEL SECURITY;

-- 3. DROP OLD POLICIES (to ensure a clean state)
DROP POLICY IF EXISTS "Admins can do everything on employees." ON employees;
DROP POLICY IF EXISTS "Admins/HR can view all attendance." ON attendance;
DROP POLICY IF EXISTS "Managers/Admins can review leaves." ON leaves;
DROP POLICY IF EXISTS "Admins can manage settings." ON settings;

-- 4. EMPLOYEE TABLE POLICIES (Recursive-Safe)
CREATE POLICY "Public profiles are viewable by everyone." ON employees FOR SELECT USING (true);
CREATE POLICY "Users can insert own profile." ON employees FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update own profile." ON employees FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Admins can do everything on employees." ON employees FOR ALL TO authenticated USING (
  get_my_role() = 'ADMIN'
);

-- 5. ATTENDANCE TABLE POLICIES
CREATE POLICY "Users can view own attendance." ON attendance FOR SELECT USING (auth.uid() = employee_id);
CREATE POLICY "Users can punch in." ON attendance FOR INSERT WITH CHECK (auth.uid() = employee_id);
CREATE POLICY "Users can update own record." ON attendance FOR UPDATE USING (auth.uid() = employee_id);
CREATE POLICY "Admins/HR can view all attendance." ON attendance FOR SELECT TO authenticated USING (
  get_my_role() IN ('ADMIN', 'HR')
);

-- 6. LEAVES TABLE POLICIES
CREATE POLICY "Users can view own leaves." ON leaves FOR SELECT USING (auth.uid() = employee_id);
CREATE POLICY "Users can apply for leave." ON leaves FOR INSERT WITH CHECK (auth.uid() = employee_id);
CREATE POLICY "Managers/Admins can review leaves." ON leaves FOR ALL TO authenticated USING (
  get_my_role() IN ('ADMIN', 'HR', 'MANAGER')
);

-- 7. SETTINGS TABLE POLICIES
CREATE POLICY "Settings are viewable by everyone." ON settings FOR SELECT USING (true);
CREATE POLICY "Admins can manage settings." ON settings FOR ALL TO authenticated USING (
  get_my_role() = 'ADMIN'
);
```

## Phase 3: Enabling Realtime
1. Go to **Database** > **Replication** in the Supabase Sidebar.
2. Click on **'supabase_realtime'** publication.
3. Toggle the switch for `attendance`, `leaves`, and `employees`.
